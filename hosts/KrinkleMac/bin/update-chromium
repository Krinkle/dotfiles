#!/bin/bash -ue

# Update Chromium (on OS X) to the latest nightly build.
# https://git.chromium.org/git/chromium.git

app_dir='/Applications/Chromium.app'
bin_dir="${app_dir}/Contents/MacOS"
tmp_dir=${TMPDIR:-~/tmp}
# Release channels:
# - "snapshots" (compiles without errors)
# - "continous" (compiles and passes automated tests)
# See https://www.chromium.org/getting-involved/download-chromium
function snapshots_url {
    base_url='https://www.googleapis.com/download/storage/v1/b/chromium-browser-snapshots/o/Mac'
    echo "$base_url${1//\//%2F}?alt=media"
}
build=$(curl -s -f "$(snapshots_url '/LAST_CHANGE')")
installed=$(echo `/usr/libexec/PlistBuddy -c 'Print :SCMRevision' ${app_dir}/Contents/Info.plist | ack -o '(?<=#)\d+'`)
script=$(basename $0)

function notice {
    echo $(tput setaf 7)[$(tput setaf 4)${script}$(tput setaf 7)]$(tput sgr0) $@
}

function do_upgrade {
    mkdir -p "$tmp_dir"
    curl -L -# -o "${tmp_dir}/chrome-${build}.zip" "$(snapshots_url "/${build}/chrome-mac.zip")"
    rm -rf "${tmp_dir}/chrome-mac"
    unzip -o -q -x "${tmp_dir}/chrome-${build}.zip" -d "${tmp_dir}"
    pkill Chromium; sleep 2; pkill Chromium
    rm -rf "$app_dir"
    mv "${tmp_dir}/chrome-mac/Chromium.app" "/Applications"
    rm -rf "${tmp_dir}/chrome-mac" "chrome-${build}.zip"
}

function patch_for_debug {
    echo "#!/bin/sh
    exec ${bin_dir}/Chromium --remote-debugging-port=9222 --disable-translate" > "${bin_dir}/ChromiumDebug"
    chmod +x "${bin_dir}/ChromiumDebug"
    /usr/libexec/PlistBuddy -c "Set :CFBundleExecutable ChromiumDebug" "${app_dir}/Contents/Info.plist"
    /System/Library/Frameworks/CoreServices.framework/Frameworks/LaunchServices.framework/Support/lsregister -f "$app_dir"
}

if [ "$installed" = "$build" ]; then
    notice "Latest version $installed already installed"
else
    notice "Upgrading to $build (you have ${installed})..."
    do_upgrade && patch_for_debug >/dev/null 2>&1
fi
