#!/bin/bash -ue

if [ -z "${1:-}" ]; then
	# Missing parameters
	echo
	echo "  Usage: $(basename $0) <version>"
	echo
	echo '  Options:'
	echo '    <version>  MediaWiki version, e.g. "1.25" or "1.27"'
	echo
	exit 1
fi

remote='origin'
prefix=$1
if (( $(echo "$prefix >= 1.27" | bc ) )); then
	prefix="$prefix.0-"
fi
git remote update $remote
git remote prune $remote
# Examples: "wmf/1.26wmf21", "wmf/1.27.0-wmf.12".
# Use a strict prefix with "wmf" mach to avoid disasted when passing "1.2"
# (e.g. don't expand as "1.20 - 1.29" or "1.200")
refs=`git for-each-ref --format='%(refname)' "refs/remotes/${remote}/wmf/${prefix}wmf*"`
branches=()
for ref in $refs; do
	echo $ref
	branch=$(echo $ref | cut -d '/' -f 4-6)
	branches+=("$branch")
done
if [ -n "${branches:-}" ]; then
	for branch in "${branches[@]}"; do
		if git push $remote ":refs/heads/$branch" > /dev/null 2>&1; then
			echo "... removed branch $branch"
		else
			echo "Could not remove $branch"
		fi
	done
fi
git remote prune $remote
