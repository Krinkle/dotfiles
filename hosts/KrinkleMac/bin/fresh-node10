#!/bin/bash -u
#
# Create a fresh container and start a Bash session within it.
#
# The current working directory is mounted at /$basename,
# and the prompt will start in that directory.
#
# Install:
#
#  1. Save this file to /usr/local/bin/fresh
#  2. Run `chmod +x /usr/local/bin/fresh`
#
# If you prefer a more explicit command name, one could instead
# save it as "fresh-node", or "fresh-node10".
#
# Usage:
#
#   self@precious.local$ cd dev/oojs/
#   self@precious.local$ fresh
#
#   # Fresh environment!
#   nobody@a35a3fd21257:/oojs$ npm install
#   nobody@a35a3fd21257:/oojs$ npm test
#   nobody@a35a3fd21257:/oojs$ npm run doc
#   nobody@a35a3fd21257:/oojs$ exit
#
# The directory from your workstation where you launched the shell
# from, is the only directory that is visible from your workstation.
# Everything else within the container is ephemeral, and unique to
# that specific shell session.
#
# And yes, you can have multiple shells open!
# Each shell gets its own fresh container.
#
# It is efficient in terms of disk space. Docker internally uses
# UnionFS, which for our purposes means that if you launch 10 shells,
# it won't cost you the diskspace of 10 Debian Linux installations.
# Instead, the base image is (safely) shared between containers with
# only local changes being tracked locally (e.g. copy-on-write).
#
# Enjoy!
#
# -- Krinkle, 2019
#

imagename=docker-registry.wikimedia.org/releng/node10-test-browser
imageversion=0.2.3
shortname=fresh-node10

# Set title
basename=$(basename "$PWD")
proctitle="$shortname â€¦$basename"
echo -e '\033]2;'$proctitle'\007'
# Restore title afterwards
trap "echo -e '\033]2;\007'" 0 SIGTERM SIGINT

# Color codes http://linux.101hacks.com/ps1-examples/prompt-color-using-tput/
CLR_NONE=`tput sgr0`
CLR_BOLD=`tput bold`
CLR_GREEN=`tput setaf 2`
CLR_YELLOW=`tput setaf 3`
CLR_GREY=`tput setaf 7`

welcomecmd=". /etc/os-release
echo \"$CLR_GREY# instance of $CLR_NONE$imagename$CLR_GREY:$CLR_BOLD$CLR_YELLOW$imageversion$CLR_NONE$CLR_GREY
#
#  os: \$PRETTY_NAME
#  mount: /$basename âžŸ $PWD
#  software:
#  - Node.js \$(node --version) (npm \$(npm --version))
#  - Chromium \$(chromium --product-version)
#  - \$(firefox --version)
#  - Ruby 2.3.3 (JSDuck 5.3.4)
#    \$(ruby --version)
#    \$(jsduck --version)

ðŸŒ±  ${CLR_BOLD}${CLR_GREEN}Fresh!
$CLR_NONE\""

# Launch faster by avoiding the various --version commands
welcomecmd_static="echo \"$CLR_GREY# instance of $CLR_NONE$imagename$CLR_GREY:$CLR_BOLD$CLR_YELLOW$imageversion$CLR_NONE$CLR_GREY
#
#  os: Debian GNU/Linux 9 (stretch)
#  mount: /$basename âžŸ $PWD
#  software:
#  - Node.js v10.4.0 (npm 6.5.0)
#  - Chromium 71.0.3578.80
#  - Mozilla Firefox 60.4.0
#  - Ruby 2.3.3 (JSDuck 5.3.4)

ðŸŒ±  ${CLR_BOLD}${CLR_GREEN}Fresh!
$CLR_NONE\""

docker run --rm --interactive --tty \
	--volume /"$PWD"://"$basename" -e 'HOME=/tmp' \
	--entrypoint /bin/sh \
	"$imagename:$imageversion" \
	-c "cd /$basename/;$welcomecmd_static;bash"
